name: Daily README Update

on:
  schedule:
    - cron: '0 0 * * *'  # Runs every day at midnight UTC
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update README
        run: |
          CURRENT_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          CURRENT_DAY=$(date -u +"%A, %B %d, %Y")
          
          python3 << 'PYTHON_SCRIPT'
          import re
          
          current_date = "$CURRENT_DATE"
          current_day = "$CURRENT_DAY"
          
          try:
              with open('README.md', 'r', encoding='utf-8') as f:
                  content = f.read()
          except FileNotFoundError:
              content = """# Daily Git Request
          
          ## Last Updated
          Last update: Not yet updated
          
          ### Recent Updates
          """
          
          # Update Last Updated section
          if '## Last Updated' in content:
              content = re.sub(r'Last update:.*', f'Last update: {current_date}', content)
              if 'Date:' in content.split('## Last Updated')[1].split('##')[0]:
                  content = re.sub(r'Date:.*', f'Date: {current_day}', content)
              else:
                  content = re.sub(r'(Last update:.*)', f'\\1\nDate: {current_day}', content)
          else:
              first_heading_end = content.find('\n', content.find('#'))
              if first_heading_end != -1:
                  content = (content[:first_heading_end+1] + 
                            f'\n## Last Updated\nLast update: {current_date}\nDate: {current_day}\n' + 
                            content[first_heading_end+1:])
          
          # Update Recent Updates
          new_entry = f'- {current_day} - Automated daily update'
          
          if '### Recent Updates' in content:
              if new_entry not in content:
                  content = content.replace('### Recent Updates', f'### Recent Updates\n{new_entry}', 1)
                  
                  # Limit to 30 entries
                  lines = content.split('\n')
                  recent_idx = next((i for i, line in enumerate(lines) if line.strip() == '### Recent Updates'), None)
                  if recent_idx is not None:
                      entries = []
                      i = recent_idx + 1
                      while i < len(lines) and not lines[i].strip().startswith('##'):
                          if lines[i].strip().startswith('-'):
                              entries.append(lines[i])
                          i += 1
                      
                      if len(entries) > 30:
                          before = '\n'.join(lines[:recent_idx+1])
                          after = '\n'.join(lines[i:]) if i < len(lines) else ''
                          content = before + '\n' + '\n'.join(entries[:30]) + '\n' + after
          else:
              if not content.endswith('\n'):
                  content += '\n'
              content += f'\n### Recent Updates\n{new_entry}\n'
          
          with open('README.md', 'w', encoding='utf-8') as f:
              f.write(content)
          
          print("README.md updated successfully")
          PYTHON_SCRIPT
      
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git checkout -B main
          git add README.md
          git diff --staged --quiet || git commit -m "Daily update: $(date -u +'%Y-%m-%d')"
          git push origin main
