name: Daily README Update

on:
  schedule:
    - cron: '0 0 * * *'  # Runs every day at midnight UTC
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update README
        run: |
          export CURRENT_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          export CURRENT_DAY=$(date -u +"%A, %B %d, %Y")
          
          echo "Current date: $CURRENT_DATE"
          echo "Current day: $CURRENT_DAY"
          
          python3 << 'PYTHON_SCRIPT'
          import re
          import sys
          import os
          import random
          
          current_date = os.environ.get('CURRENT_DATE', 'Not set')
          current_day = os.environ.get('CURRENT_DAY', 'Not set')
          
          # Random name selection
          names = ['TizLion AI', 'Tiz bot', 'tiz AI', 'Tiz Lion', 'tiz AI bot']
          selected_name = random.choice(names)
          
          print(f"Updating README with date: {current_date}")
          print(f"Updating README with day: {current_day}")
          print(f"Selected random name: {selected_name}")
          
          try:
              with open('README.md', 'r', encoding='utf-8') as f:
                  content = f.read()
              print("README.md read successfully")
          except FileNotFoundError:
              print("README.md not found, creating default")
              content = """# Daily Git Request
          
          ## Last Updated
          Last update: Not yet updated
          
          ### Recent Updates
          """
          
          original_content = content
          
          # Update Last Updated section
          if '## Last Updated' in content:
              print("Found '## Last Updated' section")
              # Replace Last update line with date and random name
              content = re.sub(r'Last update:.*', f'Last update: {current_date} by {selected_name}', content)
              print(f"Updated 'Last update' to: {current_date} by {selected_name}")
              
              # Check if Date line exists in the Last Updated section
              last_updated_section = content.split('## Last Updated')[1].split('##')[0]
              if 'Date:' in last_updated_section:
                  print("Found existing Date line, updating it")
                  content = re.sub(r'Date:.*', f'Date: {current_day}', content)
              else:
                  print("No Date line found, adding it")
                  content = re.sub(r'(Last update:.*)', f'\\1\nDate: {current_day}', content)
          else:
              print("'## Last Updated' section not found, adding it")
              first_heading_end = content.find('\n', content.find('#'))
              if first_heading_end != -1:
                  content = (content[:first_heading_end+1] + 
                            f'\n## Last Updated\nLast update: {current_date} by {selected_name}\nDate: {current_day}\n' + 
                            content[first_heading_end+1:])
          
          # Update Recent Updates
          new_entry = f'- {current_day} - Automated daily update by {selected_name}'
          print(f"New entry to add: {new_entry}")
          
          if '### Recent Updates' in content:
              print("Found '### Recent Updates' section")
              if new_entry not in content:
                  print("Entry doesn't exist, adding it")
                  content = content.replace('### Recent Updates', f'### Recent Updates\n{new_entry}', 1)
                  
                  # Limit to 30 entries
                  lines = content.split('\n')
                  recent_idx = next((i for i, line in enumerate(lines) if line.strip() == '### Recent Updates'), None)
                  if recent_idx is not None:
                      entries = []
                      i = recent_idx + 1
                      while i < len(lines) and not lines[i].strip().startswith('##'):
                          if lines[i].strip().startswith('-'):
                              entries.append(lines[i])
                          i += 1
                      
                      print(f"Found {len(entries)} entries in Recent Updates")
                      if len(entries) > 30:
                          print("Limiting to 30 entries")
                          before = '\n'.join(lines[:recent_idx+1])
                          after = '\n'.join(lines[i:]) if i < len(lines) else ''
                          content = before + '\n' + '\n'.join(entries[:30]) + '\n' + after
              else:
                  print("Entry already exists, skipping duplicate")
          else:
              print("'### Recent Updates' section not found, adding it")
              if not content.endswith('\n'):
                  content += '\n'
              content += f'\n### Recent Updates\n{new_entry}\n'
          
          # Write updated content
          with open('README.md', 'w', encoding='utf-8') as f:
              f.write(content)
          
          if content != original_content:
              print("README.md updated successfully - changes detected")
          else:
              print("WARNING: README.md content unchanged!")
          
          # Show what changed
          print("\n=== Changes made ===")
          import difflib
          diff = difflib.unified_diff(
              original_content.splitlines(keepends=True),
              content.splitlines(keepends=True),
              fromfile='original',
              tofile='updated'
          )
          for line in diff:
              print(line, end='')
          PYTHON_SCRIPT
          
          echo "Showing git status:"
          git status
          
          echo "Showing diff:"
          git diff README.md || echo "No changes detected by git"
          
          echo "Verifying variables were set:"
          echo "CURRENT_DATE in env: $CURRENT_DATE"
          echo "CURRENT_DAY in env: $CURRENT_DAY"
      
      - name: Commit and push changes
        run: |
          git config --local user.email "${{ github.actor }}@users.noreply.github.com"
          git config --local user.name "${{ github.actor }}"
          git checkout -B main
          
          echo "Adding README.md to staging..."
          git add README.md
          
          echo "Checking for changes..."
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            echo "Changes detected, committing..."
            git commit -m "Daily update: $(date -u +'%Y-%m-%d')" || echo "Commit failed"
            echo "Pushing to main..."
            git push origin main || echo "Push failed"
            echo "Push completed"
          fi
          
          echo "Final git status:"
          git status
